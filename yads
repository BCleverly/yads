#!/bin/bash

# YADS - Yet Another Development Server
# Remote PHP Web Development Server with Cloudflared Tunnels

set -euo pipefail

# Script directory - handle symlinks properly
get_script_dir() {
    local source="${BASH_SOURCE[0]}"
    while [[ -L "$source" ]]; do
        local dir="$(cd -P "$(dirname "$source")" && pwd)"
        source="$(readlink "$source")"
        if [[ "$source" != /* ]]; then
            source="$dir/$source"
        fi
    done
    echo "$(cd -P "$(dirname "$source")" && pwd)"
}

SCRIPT_DIR="$(get_script_dir)"
MODULES_DIR="${SCRIPT_DIR}/modules"

# Color setup
setup_colors() {
    # Check if we have a terminal and colors are supported
    if [[ -t 1 ]] && [[ -t 2 ]] && [[ -z "${NO_COLOR-}" ]] && [[ "${TERM-}" != "dumb" ]] && [[ "${TERM-}" != "unknown" ]]; then
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;94m'      # Light blue instead of dark blue
        CYAN='\033[0;96m'      # Light cyan
        WHITE='\033[1;37m'     # Bright white for better contrast
        GRAY='\033[0;37m'      # Light gray for secondary text
        NC='\033[0m' # No Color
    else
        RED=''
        GREEN=''
        YELLOW=''
        BLUE=''
        CYAN=''
        WHITE=''
        GRAY=''
        NC=''
    fi
}

# Logging functions
log() {
    echo -e "$1" >&2
}

error_exit() {
    log "${RED}❌ Error: $1${NC}"
    exit 1
}

warning() {
    log "${YELLOW}⚠️  Warning: $1${NC}"
}

info() {
    log "${BLUE}ℹ️  $1${NC}"
}

success() {
    log "${GREEN}✅ $1${NC}"
}

# Version detection
get_version() {
    # Try Git tags first (preferred)
    if command -v git >/dev/null 2>&1 && [[ -d "${SCRIPT_DIR}/.git" ]]; then
        local git_tag
        git_tag=$(git -C "${SCRIPT_DIR}" describe --tags --exact-match 2>/dev/null || true)
        if [[ -n "${git_tag}" ]]; then
            echo "${git_tag#v}"  # Remove 'v' prefix
            return
        fi
    fi
    
    # Fallback to version file
    if [[ -f "${SCRIPT_DIR}/version" ]]; then
        cat "${SCRIPT_DIR}/version"
        return
    fi
    
    # Fallback to script content
    local version_line
    version_line=$(grep -E '^# Version:' "${SCRIPT_DIR}/yads" 2>/dev/null | head -1 || true)
    if [[ -n "${version_line}" ]]; then
        echo "${version_line#*: }"
        return
    fi
    
    # Default version
    echo "1.0.0"
}

# Check if module exists and is readable
check_module() {
    local module="$1"
    if [[ ! -f "${MODULES_DIR}/${module}.sh" ]]; then
        error_exit "Module '${module}' not found at ${MODULES_DIR}/${module}.sh"
    fi
    if [[ ! -r "${MODULES_DIR}/${module}.sh" ]]; then
        error_exit "Module '${module}' is not readable"
    fi
}

# Debug function to show paths
debug_paths() {
    echo "Script directory: $SCRIPT_DIR"
    echo "Modules directory: $MODULES_DIR"
    echo "Available modules:"
    ls -la "$MODULES_DIR" 2>/dev/null || echo "Modules directory not found"
}

# Source module with error handling
source_module() {
    local module="$1"
    check_module "$module"
    source "${MODULES_DIR}/${module}.sh"
}

# Show help
show_help() {
    echo -e "${CYAN}YADS - Yet Another Development Server${NC}"
    echo -e "${BLUE}Remote PHP Web Development Server with Cloudflared Tunnels${NC}"
    echo
    echo -e "${YELLOW}Usage:${NC}"
    echo -e "${WHITE}  yads <command> [options]${NC}"
    echo
    echo -e "${YELLOW}Commands:${NC}"
    echo -e "${WHITE}  install                 Install YADS development server${NC}"
    echo -e "${WHITE}  uninstall               Uninstall YADS (preserves SSH keys)${NC}"
    echo -e "${WHITE}  start                   Start all services${NC}"
    echo -e "${WHITE}  stop                    Stop all services${NC}"
    echo -e "${WHITE}  restart                 Restart all services${NC}"
    echo -e "${WHITE}  status                  Show service status${NC}"
    echo -e "${WHITE}  php <version>           Install specific PHP version (5.6-8.5, defaults to 8.4)${NC}"
    echo -e "${WHITE}  server <type>           Switch web server (apache|nginx|frankenphp)${NC}"
    echo -e "${WHITE}  database <type>         Install database (mysql|postgresql)${NC}"
    echo -e "${WHITE}  tunnel                  Configure Cloudflared tunnel${NC}"
    echo -e "${WHITE}  tunnel dashboard         Show Cloudflare dashboard setup help${NC}"
    echo -e "${WHITE}  vscode                  Configure VS Code Server${NC}"
    echo -e "${WHITE}  project <name>          Create new project${NC}"
    echo -e "${WHITE}  help                    Show this help message${NC}"
    echo -e "${WHITE}  version                 Show version information${NC}"
    echo
    echo -e "${YELLOW}Examples:${NC}"
    echo -e "${GRAY}  yads install                    # Install complete development server${NC}"
    echo -e "${GRAY}  yads php 8.2                    # Install PHP 8.2${NC}"
    echo -e "${GRAY}  yads server nginx               # Switch to Nginx${NC}"
    echo -e "${GRAY}  yads database mysql             # Install MySQL${NC}"
    echo -e "${GRAY}  yads project myapp              # Create new project 'myapp'${NC}"
    echo -e "${GRAY}  yads tunnel setup               # Setup Cloudflared tunnel${NC}"
    echo
    echo -e "${YELLOW}Prerequisites:${NC}"
    echo -e "${GRAY}  - Ubuntu/Debian/CentOS/RHEL/Fedora/Arch Linux${NC}"
    echo -e "${GRAY}  - Root or sudo access${NC}"
    echo -e "${GRAY}  - Internet connection${NC}"
    echo -e "${GRAY}  - Cloudflare account (for tunnels)${NC}"
    echo
    echo -e "${YELLOW}Version:${NC} ${WHITE}$(get_version)${NC}"
}

# Main command handler
main() {
    setup_colors
    
    # Handle help and version flags
    case "${1:-}" in
        -h|--help|help)
            show_help
            exit 0
            ;;
        -v|--version|version)
            echo "YADS $(get_version)"
            exit 0
            ;;
        --test-colors)
            echo -e "${RED}Red${NC} ${GREEN}Green${NC} ${YELLOW}Yellow${NC} ${BLUE}Light Blue${NC} ${CYAN}Light Cyan${NC} ${WHITE}Bright White${NC} ${GRAY}Light Gray${NC}"
            exit 0
            ;;
        --debug-paths)
            debug_paths
            exit 0
            ;;
        "")
            show_help
            exit 1
            ;;
    esac
    
    local command="$1"
    shift 2>/dev/null || true
    
    # Source appropriate module based on command
    case "$command" in
        install)
            source_module "install"
            install_main "$@"
            ;;
        uninstall)
            source_module "uninstall"
            uninstall_main "$@"
            ;;
        start|stop|restart|status)
            source_module "services"
            services_main "$command" "$@"
            ;;
        php)
            source_module "php"
            php_main "$@"
            ;;
        server)
            source_module "webserver"
            webserver_main "$@"
            ;;
        database)
            source_module "database"
            database_main "$@"
            ;;
        tunnel)
            source_module "tunnel"
            tunnel_main "$@"
            ;;
        vscode)
            source_module "vscode"
            vscode_main "$@"
            ;;
        project)
            source_module "project"
            project_main "$@"
            ;;
        *)
            error_exit "Unknown command: $command. Use 'yads help' for available commands."
            ;;
    esac
}

# Run main function with all arguments
main "$@"
